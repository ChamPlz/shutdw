<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Controle de Energia</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>

  <div class="card">

    <h1>⚡ ShutDW </h1>
    <h2> Desligamento automatico</h2>

    <!-- ABAS -->
    <div class="tabs">
      <button class="tab active" onclick="showTab('control')">Controle</button>
      <button class="tab" onclick="showTab('config')">Config</button>
    </div>

    <!-- CONTROLE -->
    <div id="control" class="tab-content">
      
      <h2>Coloque sua senha:</h2>
      <input id="pin" type="password" placeholder="PIN" />

      <button class="btn danger" onclick="send('/shutdown')">
        Desligar agora
      </button>

      <h2>Desligar em:</h2>

      <div class="grid">
        <button class="btn" onclick="send('/shutdown/10')">10 min</button>
        <button class="btn" onclick="send('/shutdown/30')">30 min</button>
        <button class="btn" onclick="send('/shutdown/60')">60 min</button>
      </div>

      <button class="btn cancel" onclick="send('/cancel')">
        Cancelar
      </button>

      <h2>Acesso pelo celular</h2>

      <div class="qr-box">
        <img id="qr" />
        <a id="link" target="_blank"></a>
      </div>

      <h2>Agendar horário</h2>

      <input type="time" id="timePicker">

      <button class="btn" onclick="scheduleExact()">
        Agendar
      </button>

      <p id="timer"></p>
      <p id="status"></p>
    </div>

    <!-- CONFIG -->
    <div id="config" class="tab-content hidden">

      <h2>Configurações</h2>
      <h4> senha padrão: 1234567</h4>
      
      <input id="pin" type="password" placeholder="PIN" />

      <input id="newPin" type="password" placeholder="Novo PIN" />

      <button class="btn pd" onclick="savePin()">
        Salvar PIN
      </button>

      <p id="configStatus"></p>
    </div>

  </div>

  <script>
    const pinInput = document.getElementById("pin");
    const status = document.getElementById("status");
    const timer = document.getElementById("timer");

    /* -------- ABAS -------- */
    function showTab(tab) {
      document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(t => t.classList.add("hidden"));

      document.querySelector(`[onclick="showTab('${tab}')"]`).classList.add("active");
      document.getElementById(tab).classList.remove("hidden");
    }

    /* -------- AÇÕES -------- */
    function send(route) {
      fetch(route, {
        method: "POST",
        headers: { "x-pin": pinInput.value }
      })
        .then(r => r.json())
        .then(d => status.innerText = d.status || d.error);
    }

    function scheduleExact() {
      fetch("/schedule", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-pin": pinInput.value
        },
        body: JSON.stringify({
          time: document.getElementById("timePicker").value
        })
      })
        .then(r => r.json())
        .then(d => status.innerText = d.status || d.error);
    }

    /* -------- TIMER -------- */
    setInterval(() => {
      fetch("/status")
        .then(r => r.json())
        .then(d => {
          if (d.remaining == null) {
            timer.innerText = "";
            return;
          }
          const m = Math.floor(d.remaining / 60);
          const s = d.remaining % 60;
          timer.innerText = `⏳ ${m}m ${s}s restantes`;
        });
    }, 1000);

    /* -------- CONFIG -------- */
    function savePin() {
      fetch("/config/pin", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-pin": pinInput.value
        },
        body: JSON.stringify({
          newPin: document.getElementById("newPin").value
        })
      })
        .then(r => r.json())
        .then(d => document.getElementById("configStatus").innerText = d.status || d.error);
    }

    fetch("/ip")
      .then(r => r.json())
      .then(d => {
        const url = d.url;

        document.getElementById("qr").src =
          "https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=" +
          encodeURIComponent(url);

        const link = document.getElementById("link");
        link.href = url;
        link.innerText = url;
      });
  </script>

</body>

</html>